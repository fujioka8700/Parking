# 立体駐車場故障対応管理システム 要件定義書

## 1. プロジェクト概要

### 1.1 プロジェクト名

立体駐車場故障対応管理システム（Parking Fault Management System）

### 1.2 バージョン

1.0.0

### 1.3 作成日

2024 年 12 月 27 日

### 1.4 最終更新日

2024 年 12 月 27 日

---

## 2. 目的・背景

### 2.1 背景

立体駐車場の故障対応業務において、操作画面に表示される故障コードと故障内容を基に、適切な対応方法を迅速に確認し、修理対応を行う必要がある。現在は、エクセルファイル「TP_manual.xls」に記載された故障コード一覧、故障内容、対応方法を手動で確認している。

### 2.2 目的

- 故障コードから対応方法を迅速に検索できるようにする
- 対応履歴を記録・管理し、過去の対応事例を参照できるようにする
- 故障の発生傾向を把握し、予防保全に活用できるようにする
- 現場での作業効率を向上させる

### 2.3 対象ユーザー

- 立体駐車場の故障対応を行う技術者
- 故障対応の管理を行う管理者

---

## 3. 現状の課題

### 3.1 業務上の課題

1. **検索の非効率性**: エクセルファイルから故障コードを手動で検索する必要がある
2. **対応履歴の未管理**: 過去の対応履歴が記録されていない
3. **情報の分散**: 故障コード、故障内容、対応方法が一箇所にまとまっていない
4. **現場でのアクセス性**: エクセルファイルを常に持ち歩く必要がある
5. **統計情報の欠如**: 故障の発生傾向やよくある故障が把握できない

### 3.2 技術的な課題

1. エクセルファイルの構造が複雑（4 シート、ヘッダー行が 3 行目）
2. M コード（M32, M33 など）と表示コード（1, 2, 3 など）の 2 種類のコード体系
3. 欠番の処理が必要（120 個中 51 個が欠番）

---

## 4. 解決策

### 4.1 システムの概要

Web アプリケーションとして、以下の機能を提供する：

- 故障コードの高速検索機能
- 対応履歴の記録・管理機能
- 統計情報の可視化
- モバイル対応による現場での利用

### 4.2 期待される効果

- 故障コード検索時間の短縮（手動検索から数秒での検索）
- 対応履歴の蓄積によるノウハウの共有
- 故障傾向の把握による予防保全の推進
- 現場での即座の情報アクセス

---

## 5. 機能要件

### 5.1 故障コード検索機能

#### 5.1.1 検索方法

- **M コード検索**: M32, M33 などの M コードで検索
- **表示コード検索**: 1, 2, 3 などの表示コードで検索
- **故障名称検索**: 故障名称の全文検索
- **故障内容検索**: 故障内容の全文検索
- **複合検索**: 上記の組み合わせ検索

#### 5.1.2 検索結果表示

- 故障コード（M コード、表示コード）
- 故障名称
- 故障内容（要約表示、詳細はモーダルで表示）
- 対応方法・チェック項目（要約表示、詳細はモーダルで表示）
- 過去の対応履歴へのリンク

#### 5.1.3 詳細表示

- 全情報の表示
- 過去の対応履歴一覧
- お気に入り登録ボタン

### 5.2 エクセルインポート機能

#### 5.2.1 ファイルアップロード

- エクセルファイル（.xls, .xlsx）のアップロード
- ファイルサイズ制限: 10MB
- 対応ファイル: 「TP_manual.xls」形式

#### 5.2.2 データ解析

- 自動的に「異常コード」シートを認識
- ヘッダー行（3 行目）を自動検出
- 列マッピングの自動認識
  - A 列: M コード
  - B 列: 表示コード
  - C 列: 故障名称
  - D 列: 故障内容
  - E 列: チェック項目

#### 5.2.3 データインポート

- プレビュー表示（最初の 10 行）
- 重複チェック（既存の故障コードがある場合）
- 欠番の自動除外（isActive = false）
- インポート結果の表示（成功数、失敗数、欠番数）

### 5.3 対応履歴管理機能

#### 5.3.1 対応履歴の登録

- 故障コードの選択（M コードまたは表示コード）
- 対応者名の入力
- 対応日時の入力（デフォルト: 現在時刻）
- 対応時間の入力（分単位）
- ステータスの選択（完了/未完了/保留）
- 備考・メモの入力

#### 5.3.2 対応履歴の一覧表示

- 日付順の一覧表示
- フィルタ機能
  - 日付範囲
  - ステータス
  - 故障コード
  - 対応者
- ソート機能（日付、対応時間など）
- 詳細表示

#### 5.3.3 対応履歴の統計

- 同じ故障コードの過去対応一覧
- 対応時間の平均
- 対応回数の集計

### 5.4 ダッシュボード機能

#### 5.4.1 統計情報の表示

- よくある故障のランキング（TOP5）
- 未完了対応の一覧
- 今日の対応件数
- 今月の対応件数
- 故障の発生傾向（グラフ）

#### 5.4.2 クイックアクセス

- 最近検索した故障コード
- お気に入り故障コード

### 5.5 お気に入り機能

#### 5.5.1 お気に入りの登録

- 故障コードをお気に入りに登録
- 複数の故障コードを登録可能

#### 5.5.2 お気に入りの管理

- お気に入り一覧の表示
- お気に入りの削除
- クイックアクセス

### 5.6 モバイル対応

#### 5.6.1 レスポンシブデザイン

- スマートフォン、タブレット、PC に対応
- タッチ操作に最適化

#### 5.6.2 現場での利用

- 故障コードを入力して即座に対応方法を確認
- 対応履歴を現場で記録

---

## 6. 非機能要件

### 6.1 パフォーマンス

- 検索結果の表示: 1 秒以内
- ページ読み込み時間: 3 秒以内
- 同時アクセス: 10 ユーザーまで対応

### 6.2 可用性

- システム稼働率: 99%以上
- データバックアップ: 日次自動バックアップ

### 6.3 セキュリティ

- データの暗号化（通信時）
- SQL インジェクション対策
- XSS 対策
- CSRF 対策

### 6.4 保守性

- コードの可読性
- ドキュメントの整備
- ログの記録

### 6.5 拡張性

- 将来的なユーザー認証機能の追加を考慮
- 複数の駐車場への対応を考慮
- API 化を考慮

---

## 7. データ構造

### 7.1 データベース設計

#### 7.1.1 故障マスタ（FaultMaster）

| フィールド名 | 型       | 制約             | 説明                             |
| ------------ | -------- | ---------------- | -------------------------------- |
| id           | Int      | PK, Auto         | 主キー                           |
| faultCode    | String   | UNIQUE, NOT NULL | M コード（M32, M33 など）        |
| displayCode  | String   | NULL             | 表示コード（1, 2, 3 など）       |
| faultName    | String   | NOT NULL         | 故障名称                         |
| faultContent | String   | NULL             | 故障内容（詳細）                 |
| solution     | String   | NULL             | 対応方法・チェック項目           |
| isActive     | Boolean  | DEFAULT true     | 有効フラグ（欠番の場合は false） |
| createdAt    | DateTime | NOT NULL         | 作成日時                         |
| updatedAt    | DateTime | NOT NULL         | 更新日時                         |

**インデックス**:

- faultCode
- displayCode
- faultName

#### 7.1.2 対応履歴（FaultHistory）

| フィールド名 | 型       | 制約           | 説明                                   |
| ------------ | -------- | -------------- | -------------------------------------- |
| id           | Int      | PK, Auto       | 主キー                                 |
| faultCode    | String   | FK, NOT NULL   | 故障コード（M コードまたは表示コード） |
| handledBy    | String   | NOT NULL       | 対応者名                               |
| handledAt    | DateTime | NOT NULL       | 対応日時                               |
| actualTime   | Int      | NULL           | 実際の対応時間（分）                   |
| status       | String   | DEFAULT "完了" | ステータス（完了/未完了/保留）         |
| notes        | String   | NULL           | 備考・メモ                             |
| createdAt    | DateTime | NOT NULL       | 作成日時                               |
| updatedAt    | DateTime | NOT NULL       | 更新日時                               |

**インデックス**:

- faultCode
- handledAt
- status

#### 7.1.3 お気に入り（Bookmark）

| フィールド名 | 型       | 制約         | 説明                        |
| ------------ | -------- | ------------ | --------------------------- |
| id           | Int      | PK, Auto     | 主キー                      |
| faultCode    | String   | FK, NOT NULL | 故障コード                  |
| userId       | String   | NULL         | ユーザー ID（将来的に使用） |
| createdAt    | DateTime | NOT NULL     | 作成日時                    |

**インデックス**:

- faultCode, userId（複合ユニーク）

### 7.2 データマッピング（エクセル → データベース）

| エクセル列           | データベースフィールド | 型     | 説明                        |
| -------------------- | ---------------------- | ------ | --------------------------- |
| A 列（M コード）     | faultCode              | String | 故障コード（M32, M33 など） |
| B 列（コード）       | displayCode            | String | 表示コード（1, 2, 3 など）  |
| C 列（名称）         | faultName              | String | 故障名称                    |
| D 列（内容）         | faultContent           | String | 故障内容                    |
| E 列（チェック項目） | solution               | String | 対応方法・チェック項目      |

### 7.3 データ量の見積もり

- 故障マスタ: 約 120 件（有効: 69 件、欠番: 51 件）
- 対応履歴: 月間約 50 件（年間約 600 件）
- お気に入り: ユーザーあたり約 10 件

---

## 8. 画面構成

### 8.1 トップページ（ダッシュボード）

- **URL**: `/`
- **機能**:
  - 検索バー（M コード・表示コード・故障名称で検索）
  - 未完了対応一覧（最大 5 件）
  - よくある故障 TOP5
  - 今日の対応件数
  - 今月の対応件数
  - クイックアクセス（お気に入り、最近検索）

### 8.2 故障コード検索ページ

- **URL**: `/search`
- **機能**:
  - 検索フォーム（M コード、表示コード、名称、内容で検索）
  - 検索結果一覧
    - 故障コード（M コード、表示コード）
    - 故障名称
    - 故障内容（要約）
    - 対応方法（要約）
  - 詳細表示モーダル
    - 全情報の表示
    - 過去の対応履歴
    - お気に入り登録ボタン
    - 対応履歴登録ボタン

### 8.3 エクセルインポートページ

- **URL**: `/import`
- **機能**:
  - ファイルアップロード
  - プレビュー（最初の 10 行）
  - インポート実行ボタン
  - インポート結果表示
    - 成功数
    - 失敗数
    - 欠番数
    - エラー詳細

### 8.4 対応履歴登録ページ

- **URL**: `/history/new`
- **機能**:
  - 故障コード選択（検索機能付き）
  - 対応者名入力
  - 対応日時入力（デフォルト: 現在時刻）
  - 対応時間入力（分単位）
  - ステータス選択（完了/未完了/保留）
  - 備考入力
  - 登録ボタン

### 8.5 対応履歴一覧ページ

- **URL**: `/history`
- **機能**:
  - 履歴一覧（日付、故障コード、対応者、ステータス）
  - フィルタ（日付範囲、ステータス、故障コード、対応者）
  - ソート（日付、対応時間など）
  - 詳細表示
  - 編集・削除機能

### 8.6 お気に入りページ

- **URL**: `/bookmarks`
- **機能**:
  - お気に入り一覧
  - クイックアクセス
  - 削除機能

---

## 9. 技術スタック

### 9.1 フロントエンド

- **フレームワーク**: Next.js 16
- **言語**: TypeScript
- **UI ライブラリ**: React 19
- **スタイリング**: Tailwind CSS 4
- **状態管理**: React Server Components（Next.js App Router）

### 9.2 バックエンド

- **フレームワーク**: Next.js API Routes
- **言語**: TypeScript
- **ORM**: Prisma 6
- **データベース**: PostgreSQL 16

### 9.3 インフラストラクチャ

- **コンテナ**: Docker Compose
- **アプリケーションコンテナ**: Node.js 24
- **データベースコンテナ**: PostgreSQL 16

### 9.4 開発ツール

- **パッケージマネージャー**: npm
- **リンター**: ESLint
- **エクセル解析**: xlsx 0.18.5

---

## 10. 開発スケジュール

### 10.1 フェーズ 1: 基盤構築（優先度: 高）

1. データベーススキーマの作成
2. Prisma マイグレーション
3. 基本的な UI コンポーネントの作成

### 10.2 フェーズ 2: エクセルインポート機能（優先度: 高）

1. エクセルファイル解析機能の実装
2. データインポート機能の実装
3. エラーハンドリング

### 10.3 フェーズ 3: 検索機能（優先度: 高）

1. 故障コード検索機能の実装
2. 検索結果表示機能の実装
3. 詳細表示モーダルの実装

### 10.4 フェーズ 4: 対応履歴管理機能（優先度: 中）

1. 対応履歴登録機能の実装
2. 対応履歴一覧表示機能の実装
3. フィルタ・ソート機能の実装

### 10.5 フェーズ 5: ダッシュボード機能（優先度: 中）

1. 統計情報の集計機能の実装
2. グラフ表示機能の実装
3. クイックアクセス機能の実装

### 10.6 フェーズ 6: お気に入り機能（優先度: 低）

1. お気に入り登録機能の実装
2. お気に入り一覧表示機能の実装

### 10.7 フェーズ 7: モバイル対応（優先度: 中）

1. レスポンシブデザインの実装
2. タッチ操作の最適化

---

## 11. 制約事項

### 11.1 技術的制約

- エクセルファイルの形式が固定（「TP_manual.xls」形式）
- データベースは PostgreSQL を使用
- Docker 環境での動作を前提とする

### 11.2 業務的制約

- 故障コードは M コードと表示コードの 2 種類がある
- 欠番の処理が必要（120 個中 51 個が欠番）
- 一部の故障コードには「内容」や「チェック項目」が空の場合がある

### 11.3 セキュリティ制約

- 現時点ではユーザー認証機能は含まない（将来的に追加を考慮）
- データの機密性を考慮した設計が必要

---

## 12. 将来の拡張機能

### 12.1 ユーザー認証機能

- ログイン・ログアウト機能
- ユーザー管理機能
- 権限管理機能

### 12.2 複数駐車場対応

- 駐車場マスタの追加
- 駐車場ごとの故障コード管理

### 12.3 API 化

- RESTful API の提供
- 外部システムとの連携

### 12.4 通知機能

- 緊急故障の通知
- 未完了対応のリマインダー

### 12.5 レポート機能

- 月次レポートの自動生成
- エクスポート機能（Excel/CSV/PDF）

---

## 13. 参考資料

- [エクセルファイル解析レポート](./EXCEL_ANALYSIS_REPORT.md)
- [README.md](../README.md)

---

## 14. 承認

| 役割                     | 名前 | 承認日 | 署名 |
| ------------------------ | ---- | ------ | ---- |
| プロジェクトマネージャー |      |        |      |
| 開発責任者               |      |        |      |
| 品質保証責任者           |      |        |      |

---

**文書管理情報**

- 作成者: システム開発チーム
- 承認者: （未承認）
- 配布先: プロジェクト関係者全員
